name: Deploy to EC2

on:
  push:
    branches: [ main, develop, clean-develop ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: '배포 타입'
        required: true
        default: 'both'
        type: choice
        options:
        - both
        - frontend
        - backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build backend
      run: |
        cd backend
        ./gradlew build -x test
        
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 배포 디렉토리 생성
          mkdir -p /tmp/frontend-deploy
          mkdir -p /tmp/backend-deploy
          
          # 배포 스크립트 실행
          DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'both'}" /home/ubuntu/scripts/deployment/github-deploy.sh
          
    - name: Upload frontend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        
    - name: Upload backend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-jar
        path: backend/build/libs/car-repair-estimate-0.0.1-SNAPSHOT.jar 